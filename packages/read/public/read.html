<!DOCTYPE html>
<html>
<head>
	<!-- core bundle -->
	<script src="/public/js/agent.js"></script>
	<script src="/public/js/window-page.js"></script>
	<script src="/public/pageboard/pagecut/viewer.js"></script>
	<script src="/public/pageboard/pagecut/id.js"></script>

	<!-- elements bundle -->
	<link rel="import" href="/public/pageboard/elements/page.html" />
	<link rel="import" href="/public/pageboard/elements/grid.html" />
	<link rel="import" href="/public/pageboard/elements/link.html" />

	<script>
Page.route(function(state) {
	return GET('/api/page', {
		url: state.pathname
	}).then(function(page) {

		var viewer = Pagecut.viewerInstance = new Pagecut.Viewer();

		viewer.modules.id.store = buildBlocksMap(page);

		var stylesheets = collectStylesheets({}, document);

		return viewer.modules.id.from(page).then(function(fragment) {
			if (fragment.nodeName != "BODY") throw new Error("Page renderer should fill document and return body");
			state.document = fragment.ownerDocument.cloneNode(true);
			setStylesheets(stylesheets, state.document);
		});
	}).catch(function(err) {
		console.error(err);
		var params = {
			code: err.statusCode || err.code || 500,
			message: err.message || err.toString()
		};
		/*
		document.location = Page.format({
			pathname: '/error',
			query: params
		});
		*/
		document.body.innerHTML = '<h1>Error' + params.code + '</h1>' +
			'<p>' + params.message + '</p>';
	});

	function buildBlocksMap(block, blocks) {
		if (!blocks) blocks = {};
		blocks[block.id] = block;
		if (block.children) block.children.forEach(function(item) {
			buildBlocksMap(item, blocks);
		});
		return blocks;
	}

	function collectStylesheets(sheets, doc) {
		var nodes = Array.from(doc.querySelectorAll('link[rel="import"],link[rel="stylesheet"]'));
		nodes.forEach(function(node) {
			if (node.import) collectStylesheets(sheets, node.import);
			else sheets[node.href] = node.getAttribute('href');
		});
		return sheets;
	}

	function setStylesheets(map, doc) {
		var pivot = doc.head.querySelector('script');
		var href, sheet;
		for (var k in map) {
			href = map[k];
			sheet = doc.createElement('link');
			sheet.rel = "stylesheet";
			sheet.setAttribute('href', href);
			if (pivot) doc.head.insertBefore(sheet, pivot);
			else doc.head.appendChild(sheet);
		}
	}
});
	</script>
</head>
<body></body>
</html>
