<!DOCTYPE html>
<html>
<head>
	<script src="/public/js/agent.js"></script>
	<script src="/public/js/window-page.js"></script>

	<script src="/public/pageboard/pagecut-viewer.js"></script>
	<script src="/public/pageboard/pagecut-id.js"></script>
	<script src="/public/pageboard/elements/page.js"></script>
	<script src="/public/pageboard/elements/grid/view.js"></script>
	<script src="/public/pageboard/elements/link/view.js"></script>

	<link rel="import" href="/public/pageboard/elements/grid/view.html" />
	<link rel="import" href="/public/pageboard/elements/link/view.html" />
	<script>
Page.route(function(state) {
	return GET('/api/page', {
		url: state.pathname
	}).then(function(page) {
		state.data.page = page;
		return GET({
			url: page.data.template,
			type: 'html'
		}).then(function(doc) {
			var viewer = Pagecut.viewerInstance = new Pagecut.Viewer({
				document: doc
			});
			var blocks = buildBlocksMap(page);
			viewer.modules.id.store = blocks;
			return viewer.modules.id.from(page).then(function(fragment) {
				if (fragment.nodeName != "HTML") throw new Error("Bad fragment");
				state.document = fragment.ownerDocument;
			});
		});
	}).catch(function(err) {
		console.error(err);
		document.location = Page.format({
			pathname: '/error',
			query: {
				code: err.statusCode || err.code || 500,
				message: err.message || err.toString()
			}
		});
	});

	function buildBlocksMap(block, blocks) {
		if (!blocks) blocks = {};
		blocks[block.id] = block;
		if (block.children) block.children.forEach(function(item) {
			buildBlocksMap(item, blocks);
		});
		return blocks;
	}
});
	</script>
</head>
<body>
</body>
</html>
